<!doctype html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Python Tug-of-War ‚Ä¢ Quiz</title>
  <style>
    :root{
      --bg:#f6f8fc;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --stroke:#e5e7eb;
      --shadow: 0 18px 55px rgba(15, 23, 42, .10);

      --blue:#2563eb;
      --blueSoft: rgba(37,99,235,.12);

      --red:#dc2626;
      --redSoft: rgba(220,38,38,.12);

      --ok:#16a34a;
      --bad:#ef4444;

      --rope:#c56a15;
      --rope2:#f59e0b;
      --r: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 50% 0%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(900px 500px at 50% 100%, rgba(220,38,38,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
      user-select:none;
      touch-action:manipulation;
    }

    /* topbar */
    .topbar{
      height:74px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:900;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, var(--blue), #06b6d4);
      box-shadow: 0 16px 35px rgba(37,99,235,.22);
    }
    .title{
      font-size:18px;
      letter-spacing:.2px;
    }
    .metaTop{
      display:flex; gap:12px; align-items:center;
      color: var(--muted);
      font-weight:800;
    }
    .pill{
      padding:8px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:#fff;
      white-space:nowrap;
    }
    .tools{
      display:flex; gap:10px; align-items:center;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      border:1px solid var(--stroke);
      background:#fff;
      transition: transform .12s ease;
    }
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn.primary{
      background: var(--blue);
      color:#fff;
      border-color: rgba(37,99,235,.25);
    }
    .btn.ghost{
      background:#fff;
      color: var(--text);
    }

    /* layout */
    .wrap{
      height: calc(100% - 74px);
      padding: 18px;
      display:grid;
      grid-template-columns: 1fr minmax(320px, 520px) 1fr;
      gap: 18px;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .sideHead{
      padding: 18px 18px 12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--stroke);
    }
    .sideHead .name{
      font-weight:1000;
      font-size:20px;
    }
    .scorePill{
      min-width:72px;
      text-align:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#fff;
      font-weight:1000;
    }
    .sideBody{ padding: 18px; display:grid; gap:14px; }

    .qbox{
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: #fff;
      padding: 16px;
      font-weight:950;
      line-height:1.35;
      white-space: pre-wrap;
      min-height: 100px;
    }

    .options{
      display:grid;
      gap:12px;
    }
    .opt{
      width:100%;
      text-align:left;
      padding: 14px 14px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      color: var(--text);
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .opt:active{transform: translateY(1px) scale(.995)}
    .opt.disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .opt.correct{
      border-color: rgba(22,163,74,.35);
      background: rgba(22,163,74,.08);
    }
    .opt.wrong{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
    }

    .hint{
      color: var(--muted);
      font-weight:800;
      font-size:14px;
    }

    /* center arena */
    .center{
      display:grid;
      grid-template-rows: auto 1fr;
    }
    .centerHead{
      padding: 18px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .centerTitle{
      font-weight:1000;
      color: var(--blue);
    }
    .centerSub{
      margin-top:6px;
      color: var(--muted);
      font-weight:800;
      font-size:14px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: #fff;
      font-weight:900;
      color: var(--text);
      white-space:nowrap;
    }
    .tag.red{ background: rgba(220,38,38,.08); border-color: rgba(220,38,38,.18); color:#b91c1c; }
    .arena{
      padding: 18px;
      display:grid;
      place-items:center;
    }
    .stage{
      width: min(100%, 520px);
      height: min(55vh, 460px);
      border-radius: 22px;
      border:1px solid var(--stroke);
      background:#fff;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .finish{
      position:absolute; top:16px; bottom:16px;
      width:4px;
      background: rgba(100,116,139,.45);
      border-radius:999px;
    }
    .finish.left{ left: 16% }
    .finish.right{ right: 16% }
    .midLine{
      position:absolute; top:16px; bottom:16px; left:50%;
      width:4px;
      transform: translateX(-50%);
      background: rgba(100,116,139,.25);
      border-radius:999px;
      border: 2px dashed rgba(100,116,139,.20);
    }

    .rope{
      position:absolute;
      left: 12%;
      right: 12%;
      top: 58%;
      height: 14px;
      transform: translateY(-50%);
      border-radius:999px;
      background: linear-gradient(90deg, var(--rope), var(--rope2));
      box-shadow: 0 18px 40px rgba(15,23,42,.12);
    }
    .knot{
      position:absolute;
      top: 58%;
      width: 22px; height: 22px;
      transform: translate(-50%,-50%);
      border-radius: 10px;
      background: #fff;
      border: 2px solid rgba(245,158,11,.55);
      box-shadow: 0 12px 25px rgba(245,158,11,.18);
    }

    .char{
      position:absolute;
      top: 54%;
      width: 220px;
      height: 260px;
      transform: translateY(-60%);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      pointer-events:none;
    }
    .char.left{ left: -12px; }
    .char.right{ right: -12px; }

    .char img{
      max-width: 210px;
      max-height: 240px;
      object-fit: contain;
      /* –µ–≥–µ—Ä —Å—É—Ä–µ—Ç—Ç–µ –∞“õ —Ñ–æ–Ω –±–æ–ª—Å–∞, –∞–∑–¥–∞–ø –∫”©–º–µ–∫—Ç–µ—Å–µ—Ç—ñ–Ω —Ç—Ä—é–∫ */
      background: transparent;
      filter: drop-shadow(0 22px 35px rgba(15,23,42,.18));
    }

    .ticker{
      position:absolute;
      left:50%;
      bottom: 12px;
      transform: translateX(-50%);
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.9);
      font-weight:1000;
      color: var(--text);
      max-width: 94%;
      text-align:center;
    }

    /* overlay winner */
    .overlay{
      position:fixed; inset:0;
      background: rgba(15,23,42,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 999;
    }
    .overlay.show{display:flex}
    .modal{
      width: min(900px, 96vw);
      background:#fff;
      border-radius: 26px;
      border:1px solid var(--stroke);
      box-shadow: 0 40px 120px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modalHead{
      padding: 16px 18px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modalHead h2{
      margin:0; font-size:18px; font-weight:1000;
    }
    .modalBody{
      padding: 18px;
      display:grid;
      gap:14px;
    }
    .winRow{
      display:flex;
      gap:16px;
      align-items:center;
      border:1px solid var(--stroke);
      border-radius: 22px;
      padding: 14px;
      background: #fff;
    }
    .winAvatar{
      width: 140px; height: 140px;
      border-radius: 24px;
      border:1px solid var(--stroke);
      display:grid; place-items:center;
      overflow:hidden;
      background: #fff;
    }
    .winAvatar img{
      width:100%; height:100%;
      object-fit:contain;
      filter: drop-shadow(0 18px 30px rgba(15,23,42,.18));
    }
    .winQuote{
      font-size:26px;
      font-weight:1000;
      line-height:1.15;
    }
    .winSub{
      margin-top:8px;
      color: var(--muted);
      font-weight:800;
    }

    @media (max-width: 1100px){
      body{overflow:auto}
      .wrap{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
      .stage{ height: 360px; }
      .char{ width: 200px; height: 240px; }
      .char img{ max-width: 180px; max-height: 220px; }
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">Python Tug-of-War ‚Ä¢ Quiz</div>
        <div class="metaTop">
          <span class="pill" id="roundPill">–†–∞—É–Ω–¥: 1/10</span>
          <span class="pill" id="stepPill">“ö–∞–¥–∞–º: 1/10</span>
        </div>
      </div>
    </div>

    <div class="tools">
      <button class="btn ghost" id="btnMusic">üéµ –ú—É–∑—ã–∫–∞: ON</button>
      <button class="btn ghost" id="btnSfx">üîä SFX: ON</button>
      <button class="btn ghost" id="btnReset">“ö–∞–π—Ç–∞ –±–∞—Å—Ç–∞—É</button>
      <button class="btn primary" id="btnStart">–ë–∞—Å—Ç–∞—É</button>
    </div>
  </header>

  <main class="wrap">

    <!-- LEFT -->
    <section class="card" id="leftCard">
      <div class="sideHead" style="background: linear-gradient(180deg, var(--blueSoft), transparent);">
        <div class="name">–ö”©–∫ —Ç–æ–ø</div>
        <div class="scorePill" id="scoreL">0</div>
      </div>
      <div class="sideBody">
        <div class="qbox" id="qL">–ë–∞—Å—Ç–∞—É “Ø—à—ñ–Ω ‚Äú–ë–∞—Å—Ç–∞—É‚Äù –±–∞—Å üòÑ</div>
        <div class="options" id="optsL"></div>
        <div class="hint">–ñ–∞—É–∞–ø—Ç—ã —Ç–∞“£–¥–∞ ‚Äî –±”ô—Ä—ñ –∞–≤—Ç–æ–º–∞—Ç üòâ</div>
      </div>
    </section>

    <!-- CENTER -->
    <section class="card center">
      <div class="centerHead">
        <div>
          <div class="centerTitle">–û–π—ã–Ω: –ê—Ä“õ–∞–Ω —Ç–∞—Ä—Ç—É</div>
          <div class="centerSub">–ï–∫—ñ –∂–∞“õ —Ç–∞ –∂–∞—É–∞–ø –±–µ—Ä–µ–¥—ñ. –î“±—Ä—ã—Å –∂–∞—É–∞–ø ‚Äî –∞—Ä“õ–∞–Ω ”©–∑—ñ–Ω–µ —Ç–∞—Ä—Ç—ã–ª–∞–¥—ã.</div>
        </div>
        <div class="tag red">Python test</div>
      </div>

      <div class="arena">
        <div class="stage" id="stage">
          <div class="finish left"></div>
          <div class="finish right"></div>
          <div class="midLine"></div>

          <div class="rope" id="rope"></div>
          <div class="knot" id="knot"></div>

          <div class="char left"><img id="imgRabbit" alt="rabbit"/></div>
          <div class="char right"><img id="imgFox" alt="fox"/></div>

          <div class="ticker" id="ticker">–ë–∞—Å—Ç–∞—É –±–∞—Å ‚Äî –º—É–∑—ã–∫–∞ –¥–∞ –¥–∞–π—ã–Ω üé∂</div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card" id="rightCard">
      <div class="sideHead" style="background: linear-gradient(180deg, var(--redSoft), transparent);">
        <div class="name">“ö—ã–∑—ã–ª —Ç–æ–ø</div>
        <div class="scorePill" id="scoreR">0</div>
      </div>
      <div class="sideBody">
        <div class="qbox" id="qR">–ë–∞—Å—Ç–∞—É “Ø—à—ñ–Ω ‚Äú–ë–∞—Å—Ç–∞—É‚Äù –±–∞—Å üòÑ</div>
        <div class="options" id="optsR"></div>
        <div class="hint">“ö–∞—Ç–µ –±–æ–ª—Å–∞ ‚Äî “õ–∞—Ä—Å—ã –∂–∞“õ “õ—É–∞–Ω—ã–ø –∫–µ—Ç–µ–¥—ñ üòÖ</div>
      </div>
    </section>

  </main>

  <!-- Winner overlay -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalHead">
        <h2 id="winTitle">–ñ–µ“£—ñ–º–ø–∞–∑</h2>
        <button class="btn ghost" id="btnClose">–ñ–∞–±—É</button>
      </div>
      <div class="modalBody">
        <div class="winRow">
          <div class="winAvatar" id="winAvatar"></div>
          <div>
            <div class="winQuote" id="winQuote">‚Äî</div>
            <div class="winSub" id="winSub">‚Äî</div>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="btnAgain">“ö–∞–π—Ç–∞ –æ–π–Ω–∞—É</button>
          <button class="btn ghost" id="btnJustClose">–ñ–∞–±—É</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // 0) –°–£–†–ï–¢–¢–ï–† (”®–ó–Ü“¢ “ö–û–Ø–°–´“¢)
  // =========================
  // –ú—ã—Å–∞–ª—ã: "img/fox.png" –∂”ô–Ω–µ "img/rabbit.png"
  const FOX_IMG = "assets/right.png";
  const RABBIT_IMG = "assets/left.png";

  document.getElementById("imgFox").src = FOX_IMG;
  document.getElementById("imgRabbit").src = RABBIT_IMG;

  // =========================
  // 1) AUDIO ENGINE (NO FILES)
  // =========================
  let audioCtx = null;
  let bgOn = true;
  let sfxOn = true;
  let bgTimer = null;

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }

  function tone(freq, dur=0.12, type="sine", gain=0.06, glideTo=null){
    if(!audioCtx) return;
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    if(glideTo){
      o.frequency.exponentialRampToValueAtTime(glideTo, t0 + dur);
    }

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    o.connect(g).connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + dur + 0.02);
  }

  function startBG(){
    ensureAudio();
    stopBG();
    if(!bgOn) return;

    const notes = [220, 277.18, 329.63, 392, 440, 523.25];
    let step = 0;

    bgTimer = setInterval(()=>{
      if(!bgOn) return;
      const f = notes[step % notes.length] * (step % 8 === 0 ? 0.5 : 1);
      tone(f, 0.10, "sine", 0.020, f*1.01);
      if(step % 4 === 0) tone(110, 0.14, "triangle", 0.012);
      step++;
    }, 140);
  }

  function stopBG(){
    if(bgTimer) clearInterval(bgTimer);
    bgTimer = null;
  }

  function sfxYuraa(){
    if(!sfxOn) return;
    ensureAudio();

    // fanfare
    tone(523.25, 0.10, "triangle", 0.09, 784);
    setTimeout(()=>tone(659.25, 0.10, "triangle", 0.08), 90);
    setTimeout(()=>tone(784.00, 0.12, "triangle", 0.09), 180);
    setTimeout(()=>tone(988.00, 0.14, "triangle", 0.08), 280);

    // short cheer-like noise punch
    const t0 = audioCtx.currentTime + 0.02;
    const bufferSize = Math.floor(0.18 * audioCtx.sampleRate);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++){
      data[i] = (Math.random()*2-1) * Math.exp(-i/(data.length/6));
    }
    const src = audioCtx.createBufferSource();
    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.05, t0);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
    src.buffer = buffer;
    src.connect(g).connect(audioCtx.destination);
    src.start(t0);
  }

  function sfxFail(){
    if(!sfxOn) return;
    ensureAudio();
    tone(220, 0.12, "sawtooth", 0.06, 160);
    setTimeout(()=>tone(160, 0.12, "sawtooth", 0.05), 120);
  }

  // =========================
  // 2) QUESTIONS (Python)
  // =========================
  // 10 —Ä–∞—É–Ω–¥“õ–∞ –∂–µ—Ç–µ—Ç—ñ–Ω pool. ”ò—Ä –∂–∞“õ“õ–∞ –±”©–ª–µ–∫ —Å“±—Ä–∞“õ –∫–µ–ª–µ–¥—ñ.
  const QPOOL = [
    {q:`print("py"*3)`, options:["py3","pypypy","py py py","“ö–∞—Ç–µ"], a:1},
    {q:`print(len([0,1,2,3]))`, options:["3","4","5","“ö–∞—Ç–µ"], a:1},
    {q:`print(bool(0))`, options:["True","False","0","“ö–∞—Ç–µ"], a:1},
    {q:`s="–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞"\nprint(s[2:7])`, options:["—Ñ–æ—Ä–º–∞","—Ñ–æ—Ä–º","–Ω—Ñ–æ—Ä","—Ä–º–∞—Ç–∏"], a:1},
    {q:`print(10//3)`, options:["3.33","3","1","“ö–∞—Ç–µ"], a:1},
    {q:`print(10%3)`, options:["0","1","3","“ö–∞—Ç–µ"], a:1},
    {q:`x=5\nx+=2\nprint(x)`, options:["5","7","10","“ö–∞—Ç–µ"], a:1},
    {q:`print(2**4)`, options:["6","8","16","“ö–∞—Ç–µ"], a:2},
    {q:`print(min([9,4,7]))`, options:["9","7","4","“ö–∞—Ç–µ"], a:2},
    {q:`print(max([9,4,7]))`, options:["9","7","4","“ö–∞—Ç–µ"], a:0},
    {q:`s="banana"\nprint(s.count("a"))`, options:["2","3","4","“ö–∞—Ç–µ"], a:1},
    {q:`s="python"\nprint(s[1:4])`, options:["pyt","yth","tho","“ö–∞—Ç–µ"], a:1},
    {q:`a=[3,1,2]\na.sort()\nprint(a[0])`, options:["3","2","1","“ö–∞—Ç–µ"], a:2},
    {q:`print(sum([1,2,3,4]))`, options:["9","10","11","“ö–∞—Ç–µ"], a:1},
  ];

  function pickQuestion(){
    return QPOOL[Math.floor(Math.random()*QPOOL.length)];
  }

  // =========================
  // 3) GAME STATE
  // =========================
  const TOTAL_ROUNDS = 10;

  let started = false;
  let round = 1;

  let scoreL = 0, scoreR = 0;

  // Rope visual position (-1..+1)
  let ropePos = 0;
  let ropeVel = 0;
  const DAMP = 0.90;
  const VIS_PULL_CORRECT = 0.14;
  const VIS_PULL_WRONG   = 0.08;

  // current questions
  let qL = null, qR = null;

  // each round: each side answers once
  let answeredL = false, answeredR = false;

  // =========================
  // 4) ELEMENTS
  // =========================
  const roundPill = document.getElementById("roundPill");
  const stepPill  = document.getElementById("stepPill");
  const qElL = document.getElementById("qL");
  const qElR = document.getElementById("qR");
  const optsL = document.getElementById("optsL");
  const optsR = document.getElementById("optsR");
  const scoreElL = document.getElementById("scoreL");
  const scoreElR = document.getElementById("scoreR");
  const ticker = document.getElementById("ticker");
  const knot = document.getElementById("knot");
  const stage = document.getElementById("stage");

  const btnStart = document.getElementById("btnStart");
  const btnReset = document.getElementById("btnReset");
  const btnMusic = document.getElementById("btnMusic");
  const btnSfx   = document.getElementById("btnSfx");

  const overlay = document.getElementById("overlay");
  const winTitle = document.getElementById("winTitle");
  const winQuote = document.getElementById("winQuote");
  const winSub = document.getElementById("winSub");
  const winAvatar = document.getElementById("winAvatar");
  const btnClose = document.getElementById("btnClose");
  const btnAgain = document.getElementById("btnAgain");
  const btnJustClose = document.getElementById("btnJustClose");

  // =========================
  // 5) RENDER
  // =========================
  function setTicker(msg){ ticker.textContent = msg; }
  function updateTop(){
    roundPill.textContent = `–†–∞—É–Ω–¥: ${Math.min(round, TOTAL_ROUNDS)}/${TOTAL_ROUNDS}`;
    stepPill.textContent  = `“ö–∞–¥–∞–º: ${Math.min(round, TOTAL_ROUNDS)}/${TOTAL_ROUNDS}`;
  }
  function updateScores(){
    scoreElL.textContent = scoreL;
    scoreElR.textContent = scoreR;
  }

  function renderSide(side, q){
    const qEl = side==="L" ? qElL : qElR;
    const optsWrap = side==="L" ? optsL : optsR;

    qEl.textContent = q.q;

    optsWrap.innerHTML = "";
    const letters = ["A","B","C","D"];
    q.options.forEach((t,i)=>{
      const b = document.createElement("button");
      b.className = "opt";
      b.innerHTML = `${letters[i]}) ${t}`;
      b.addEventListener("click", ()=> choose(side, i), {passive:true});
      b.addEventListener("touchstart", ()=>{}, {passive:true});
      optsWrap.appendChild(b);
    });
  }

  function disableSide(side){
    const wrap = side==="L" ? optsL : optsR;
    [...wrap.querySelectorAll(".opt")].forEach(b=>{
      b.classList.add("disabled");
      b.disabled = true;
    });
  }

  function markSide(side, choice, correct){
    const wrap = side==="L" ? optsL : optsR;
    const btns = [...wrap.querySelectorAll(".opt")];
    btns.forEach((b,i)=>{
      if(i===correct) b.classList.add("correct");
      if(i===choice && choice!==correct) b.classList.add("wrong");
    });
  }

  // =========================
  // 6) GAME FLOW
  // =========================
  function newRound(){
    answeredL = false;
    answeredR = false;

    qL = pickQuestion();
    qR = pickQuestion();

    renderSide("L", qL);
    renderSide("R", qR);

    updateTop();
    setTicker(`–†–∞—É–Ω–¥ ${round}/${TOTAL_ROUNDS} ‚Äî –ï–∫—ñ –∂–∞“õ —Ç–∞ –∂–∞—É–∞–ø –±–µ—Ä—Å—ñ–Ω!`);
  }

  function choose(side, choice){
    if(!started) return;

    if(side==="L" && answeredL) return;
    if(side==="R" && answeredR) return;

    const q = side==="L" ? qL : qR;
    const correct = q.a;
    const ok = (choice === correct);

    if(side==="L") answeredL = true; else answeredR = true;

    markSide(side, choice, correct);
    disableSide(side);

    if(ok){
      if(side==="L") scoreL++; else scoreR++;
      updateScores();
      setTicker(`${side==="L" ? "–ö”©–∫ —Ç–æ–ø" : "“ö—ã–∑—ã–ª —Ç–æ–ø"}: –î“±—Ä—ã—Å! ‚úÖ –£–†–ê–ê!`);
      sfxYuraa();
      ropeVel += (side==="L" ? -VIS_PULL_CORRECT : +VIS_PULL_CORRECT);
    }else{
      setTicker(`${side==="L" ? "–ö”©–∫ —Ç–æ–ø" : "“ö—ã–∑—ã–ª —Ç–æ–ø"}: “ö–∞—Ç–µ ‚ùå`);
      sfxFail();
      // wrong gives small pull to opponent (visual only)
      ropeVel += (side==="L" ? +VIS_PULL_WRONG : -VIS_PULL_WRONG);
    }

    // –µ–∫–µ—É—ñ –¥–µ –∂–∞—É–∞–ø –±–µ—Ä—Å–µ ‚Äî –∫–µ–ª–µ—Å—ñ —Ä–∞—É–Ω–¥
    if(answeredL && answeredR){
      setTimeout(()=>{
        round++;
        if(round > TOTAL_ROUNDS){
          finishGame();
        }else{
          newRound();
        }
      }, 650);
    }
  }

  function finishGame(){
    started = false;
    stopBG();
    setTicker("–û–π—ã–Ω –∞—è“õ—Ç–∞–ª–¥—ã! üèÅ");

    let winner = "draw";
    if(scoreL > scoreR) winner = "L";
    if(scoreR > scoreL) winner = "R";

    overlay.classList.add("show");

    winAvatar.innerHTML = "";
    const img = document.createElement("img");
    img.src = (winner==="R") ? FOX_IMG : RABBIT_IMG;
    img.alt = "winner";
    winAvatar.appendChild(img);

    if(winner==="L"){
      winTitle.textContent = "–ñ–ï“¢–Ü–ú–ü–ê–ó: –ö”®–ö –¢–û–ü";
      winQuote.textContent = "“ö–æ—è–Ω: –ö”©—Ä–¥—ñ“£ –±–µ? üòé –ú–µ–Ω —Å–µ–Ω—ñ –∂–µ“£–¥—ñ–º!";
    }else if(winner==="R"){
      winTitle.textContent = "–ñ–ï“¢–Ü–ú–ü–ê–ó: “ö–´–ó–´–õ –¢–û–ü";
      winQuote.textContent = "–¢“Ø–ª–∫—ñ: –ö”©—Ä–¥—ñ“£ –±–µ? üòº –ú–µ–Ω —Å–µ–Ω—ñ –∂–µ“£–¥—ñ–º!";
    }else{
      winTitle.textContent = "–ù”ò–¢–ò–ñ–ï: –¢–ï“¢ –û–ô–´–ù";
      winQuote.textContent = "–ï–∫–µ—É—ñ“£ –¥–µ –∫“Ø—à—Ç—ñ—Å—ñ“£–¥–µ—Ä. “ö–∞–π—Ç–∞–¥–∞–Ω! üî•";
    }
    winSub.textContent = `“∞–ø–∞–π: –ö”©–∫ ${scoreL} ‚Äî ${scoreR} “ö—ã–∑—ã–ª ‚Ä¢ –†–∞—É–Ω–¥: ${TOTAL_ROUNDS}/${TOTAL_ROUNDS}`;
  }

  function resetGame(){
    started = false;
    round = 1;
    scoreL = 0; scoreR = 0;
    ropePos = 0; ropeVel = 0;
    updateScores();
    updateTop();
    qElL.textContent = '–ë–∞—Å—Ç–∞—É “Ø—à—ñ–Ω ‚Äú–ë–∞—Å—Ç–∞—É‚Äù –±–∞—Å üòÑ';
    qElR.textContent = '–ë–∞—Å—Ç–∞—É “Ø—à—ñ–Ω ‚Äú–ë–∞—Å—Ç–∞—É‚Äù –±–∞—Å üòÑ';
    optsL.innerHTML = "";
    optsR.innerHTML = "";
    setTicker("–ë–∞—Å—Ç–∞—É –±–∞—Å ‚Äî –º—É–∑—ã–∫–∞ –¥–∞ –¥–∞–π—ã–Ω üé∂");
    stopBG();
  }

  // =========================
  // 7) ROPE ANIMATION (visual)
  // =========================
  function stageWidth(){ return stage.getBoundingClientRect().width; }
  function track(){
    const w = stageWidth();
    const left = w * 0.12;
    const right = w * 0.88;
    const mid = (left + right) / 2;
    const span = right - left;
    return {mid, span};
  }
  function updateRope(){
    ropePos += ropeVel;
    ropeVel *= DAMP;
    ropePos *= 0.992;
    if(ropePos > 1) ropePos = 1;
    if(ropePos < -1) ropePos = -1;

    const {mid, span} = track();
    const x = mid + ropePos * (span/2);
    knot.style.left = `${x}px`;

    requestAnimationFrame(updateRope);
  }

  // =========================
  // 8) UI BUTTONS
  // =========================
  btnStart.addEventListener("click", () => {
    if(started) return;
    ensureAudio();       // üëà –º–∞“£—ã–∑–¥—ã (–±—Ä–∞—É–∑–µ—Ä —Ä“±“õ—Å–∞—Ç—ã)
    if(bgOn) startBG();  // üéµ
    started = true;
    round = 1;
    scoreL = 0; scoreR = 0;
    updateScores();
    newRound();
  }, {passive:true});

  btnReset.addEventListener("click", () => {
    resetGame();
  }, {passive:true});

  btnMusic.addEventListener("click", () => {
    ensureAudio();
    bgOn = !bgOn;
    btnMusic.textContent = bgOn ? "üéµ –ú—É–∑—ã–∫–∞: ON" : "üéµ –ú—É–∑—ã–∫–∞: OFF";
    if(bgOn && started) startBG();
    if(!bgOn) stopBG();
  }, {passive:true});

  btnSfx.addEventListener("click", () => {
    ensureAudio();
    sfxOn = !sfxOn;
    btnSfx.textContent = sfxOn ? "üîä SFX: ON" : "üîá SFX: OFF";
  }, {passive:true});

  function closeOverlay(){ overlay.classList.remove("show"); }
  btnClose.addEventListener("click", closeOverlay, {passive:true});
  btnJustClose.addEventListener("click", closeOverlay, {passive:true});
  btnAgain.addEventListener("click", () => {
    closeOverlay();
    ensureAudio();
    if(bgOn) startBG();
    started = true;
    round = 1;
    scoreL = 0; scoreR = 0;
    updateScores();
    newRound();
  }, {passive:true});

  // init
  resetGame();
  updateRope();

})();
</script>
</body>
</html>
