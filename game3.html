<!doctype html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Runner Knockout</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --panel:#ffffffea;
      --ink:#0f172a;
      --shadow: 0 18px 40px rgba(2,6,23,.18);
      --r: 22px;
      --line: rgba(15,23,42,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(255,255,255,.35), transparent 55%),
        radial-gradient(900px 550px at 90% 20%, rgba(255,255,255,.25), transparent 55%),
        linear-gradient(135deg, #0ea5e9, #a78bfa 55%, #22c55e);
      overflow-x:hidden;
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,.35);
      border-bottom: 1px solid rgba(255,255,255,.35);
    }
    .topbar .wrap{
      max-width:1200px; margin:0 auto; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .left{
      display:flex; align-items:center; gap:10px; user-select:none;
      font-weight:900;
    }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      box-shadow: 0 14px 30px rgba(37,99,235,.25);
    }
    .meta{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .badge{
      font-size:12px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(255,255,255,.55);
      font-weight:900;
      box-shadow: 0 10px 24px rgba(2,6,23,.10);
      white-space:nowrap;
    }
    .btn{
      border:0;
      padding:10px 12px;
      border-radius:16px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(2,6,23,.10);
      transition: transform .08s ease, filter .08s ease, opacity .2s ease;
      display:inline-flex; align-items:center; gap:8px;
      background:#fff;
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.03); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; transform:none; }
    .btn.primary{
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      color:#fff;
    }
    .btn.danger{
      background: linear-gradient(135deg, #ef4444, #fb7185);
      color:#fff;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding:14px;
      display:grid;
      grid-template-columns: 1.45fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .container{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .bd{ padding:12px; }

    /* ARENA */
    .arena{
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.10);
      background:
        radial-gradient(500px 200px at 10% 10%, rgba(255,255,255,.65), transparent 55%),
        radial-gradient(600px 240px at 80% 20%, rgba(255,255,255,.55), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.25));
      min-height: 420px;
    }
    .arena:before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, transparent 0 8%, rgba(2,6,23,.06) 8% 8.4%, transparent 8.4% 100%),
        repeating-linear-gradient(0deg, rgba(255,255,255,0) 0 34px, rgba(15,23,42,.05) 34px 35px);
      pointer-events:none;
      opacity:.85;
    }

    .lanes{ position:relative; padding:10px 10px 14px; }
    .lane{
      position:relative;
      height: 56px;
      margin: 10px 0;
      border-radius: 18px;
      background: linear-gradient(90deg, rgba(15,23,42,.06), rgba(15,23,42,.03));
      border: 1px solid rgba(15,23,42,.08);
      overflow:hidden;
    }
    .finish{
      position:absolute;
      top:0; right: 92px;
      width: 10px; height:100%;
      background: repeating-linear-gradient(0deg, rgba(15,23,42,.25) 0 10px, rgba(255,255,255,.7) 10px 20px);
      opacity:.65;
      border-left: 2px solid rgba(255,255,255,.65);
      border-right: 2px solid rgba(255,255,255,.65);
    }
    .label{
      position:absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-weight:900;
      font-size:12px;
      color: rgba(15,23,42,.92);
      z-index:2;
      pointer-events:none;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(15,23,42,.10);
      border-radius:999px;
      padding:4px 10px;
    }

    .runner{
      position:absolute;
      left: 0;
      top: 50%;
      transform: translate(0,-50%);
      width: 56px;
      height: 34px;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 10px 22px rgba(2,6,23,.14);
      border: 1px solid rgba(2,6,23,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:3;
      will-change: transform;
    }
    .face{
      width: 26px; height: 26px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,255,255,.85), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.5), rgba(0,0,0,.05));
      border: 1px solid rgba(15,23,42,.08);
      position:relative;
      overflow:hidden;
      transform: rotate(6deg);
    }
    .face:before,.face:after{
      content:"";
      position:absolute; width:6px; height:6px; border-radius:50%;
      background: rgba(15,23,42,.75);
      top: 9px;
    }
    .face:before{ left:7px; }
    .face:after{ right:7px; }
    .mouth{
      position:absolute; left:50%; bottom:6px;
      width: 12px; height: 6px;
      transform: translateX(-50%);
      border-bottom: 2px solid rgba(15,23,42,.55);
      border-radius: 0 0 12px 12px;
      opacity:.9;
    }
    .legs{
      position:absolute;
      bottom:-7px;
      left:50%;
      transform: translateX(-50%);
      display:flex; gap:8px;
    }
    .leg{
      width:10px; height:12px;
      background: rgba(15,23,42,.35);
      border-radius: 6px;
      transform-origin: top center;
    }
    .running .leg:nth-child(1){ animation: kick .14s infinite alternate; }
    .running .leg:nth-child(2){ animation: kick .14s infinite alternate-reverse; }
    @keyframes kick{
      from{ transform: rotate(-18deg) translateY(0); }
      to{ transform: rotate(20deg) translateY(2px); }
    }

    .winnerGlow{
      box-shadow: 0 14px 36px rgba(245,158,11,.35), 0 0 0 6px rgba(245,158,11,.18) !important;
      border-color: rgba(245,158,11,.55) !important;
    }
    .lane.win{
      outline: 3px solid rgba(245,158,11,.45);
      box-shadow: 0 14px 32px rgba(245,158,11,.18);
    }

    /* BOARD */
    .boardList{ display:flex; flex-direction:column; gap:10px; }
    .boardItem{
      padding:10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.75);
      border:1px solid rgba(15,23,42,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 10px 24px rgba(2,6,23,.08);
    }
    .rank{
      width:34px; height:34px; border-radius: 14px;
      display:grid; place-items:center;
      font-weight:900;
      background: rgba(2,6,23,.06);
      border:1px solid rgba(2,6,23,.10);
    }

    .champ{
      margin-top:12px;
      padding:14px;
      border-radius: 22px;
      border: 1px solid rgba(15,23,42,.10);
      background: linear-gradient(135deg, rgba(255,255,255,.88), rgba(255,255,255,.55));
      box-shadow: 0 18px 40px rgba(2,6,23,.12);
      display:none;
      font-weight:900;
      font-size:18px;
      text-align:center;
    }
    .champ.show{ display:block; }

    .confetti{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .confetti i{
      position:absolute; width:10px; height:14px; border-radius: 3px;
      opacity:.95;
      transform: translateY(-20px) rotate(0deg);
      animation: fall 1.2s linear forwards;
    }
    @keyframes fall{
      to{ transform: translateY(520px) rotate(360deg); opacity:1; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="wrap">
      <div class="left">
        <div class="logo"></div>
        Runner
      </div>

      <div class="meta">
        <span class="badge" id="roundBadge">–†–∞—É–Ω–¥: 1</span>
        <span class="badge" id="aliveBadge">“ö–∞–ª“ì–∞–Ω—ã: 11</span>
        <button class="btn primary" id="btnStart">‚ñ∂</button>
        <button class="btn" id="btnNext" disabled>‚è≠</button>
        <button class="btn danger" id="btnReset">‚Ü∫</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="bd">
        <div class="arena" id="arena">
          <div class="confetti" id="confetti"></div>
          <div class="lanes" id="lanes"></div>
        </div>
        <div class="champ" id="championCard"><span id="championName">‚Äî</span></div>
      </div>
    </section>

    <aside class="card">
      <div class="bd">
        <div class="boardList" id="board"></div>
      </div>
    </aside>
  </main>

<script>
(() => {
  const initialPlayers = [
    "–ê—Å—ã–ª–±–µ–∫","–•—É—Ä—Å–∞–Ω–±–µ–∫","–î–∏–ª–º—É—Ä–∞—Ç","–ó–∏–ª–æ–ª–∞","–°–∞—Ä–≤–∏–Ω–æ–∑",
    "–®–æ—Ö—Å–∞–Ω–∞–º","–ú—É—Ö–∞–º–º–∞–¥–∞–ª–∏","–ñ–∞–≤–æ—Ö–∏—Ä","–ö”ô—É—Å–∞—Ä","–•–∞–∂–∏–¥–¥–∏–Ω","–®–∞–¥–∏–∞–Ω–∞"
  ];

  const palette = [
    "#fb7185","#f97316","#facc15","#4ade80","#22c55e",
    "#2dd4bf","#60a5fa","#818cf8","#a78bfa","#f472b6","#34d399"
  ];

  const lanesEl = document.getElementById("lanes");
  const boardEl = document.getElementById("board");
  const btnStart = document.getElementById("btnStart");
  const btnNext  = document.getElementById("btnNext");
  const btnReset = document.getElementById("btnReset");
  const roundBadge = document.getElementById("roundBadge");
  const aliveBadge = document.getElementById("aliveBadge");
  const confettiEl = document.getElementById("confetti");
  const championCard = document.getElementById("championCard");
  const championName = document.getElementById("championName");

  let active = [];
  let winners = [];
  let round = 1;
  let running = false;
  let rafId = null;

  let runners = [];
  let winnerIndex = -1;
  let startTime = 0;

  // WebAudio
  let audioCtx = null, master = null;
  let music = { on:false, oscA:null, oscB:null, lfo:null };
  let muted = false;

  function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain();
    master.gain.value = muted ? 0 : 0.55;
    master.connect(audioCtx.destination);
  }

  function startMusic(){
    ensureAudio();
    if (music.on) return;

    const gain = audioCtx.createGain();
    gain.gain.value = 0.08;

    const oscA = audioCtx.createOscillator();
    const oscB = audioCtx.createOscillator();
    oscA.type = "sawtooth";
    oscB.type = "triangle";

    const lfo = audioCtx.createOscillator();
    const lfoGain = audioCtx.createGain();
    lfo.type = "sine";
    lfo.frequency.value = 5.5;
    lfoGain.gain.value = 18;
    lfo.connect(lfoGain);
    lfoGain.connect(oscA.detune);
    lfoGain.connect(oscB.detune);

    const filter = audioCtx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.value = 900;
    filter.Q.value = 0.7;

    oscA.connect(filter);
    oscB.connect(filter);
    filter.connect(gain);
    gain.connect(master);

    const base = 220;
    const seq = [0,7,5,12,7,5,3,7];
    let step = 0;
    const tick = () => {
      if (!music.on) return;
      const t = audioCtx.currentTime;
      const semi = seq[step % seq.length];
      const f = base * Math.pow(2, semi/12);
      oscA.frequency.setTargetAtTime(f, t, 0.02);
      oscB.frequency.setTargetAtTime(f*0.5, t, 0.02);
      step++;
      setTimeout(tick, 240);
    };

    oscA.start(); oscB.start(); lfo.start();
    music = { on:true, oscA, oscB, lfo };
    tick();
  }

  function sfxWin(){
    ensureAudio();
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "triangle";
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.22, t + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.35);
    o.connect(g); g.connect(master);
    o.start(t);
    [660,880,990,1320].forEach((n,i)=> o.frequency.setValueAtTime(n, t + i*0.08));
    o.stop(t + 0.38);
  }

  function updateBadges(){
    roundBadge.textContent = "–†–∞—É–Ω–¥: " + round;
    aliveBadge.textContent = "“ö–∞–ª“ì–∞–Ω—ã: " + active.length;
  }

  function clearConfetti(){ confettiEl.innerHTML = ""; }
  function popConfetti(){
    clearConfetti();
    const colors = ["#facc15","#fb7185","#60a5fa","#34d399","#a78bfa","#f97316"];
    for(let i=0;i<70;i++){
      const el = document.createElement("i");
      el.style.left = (Math.random()*100) + "%";
      el.style.top = (-10 - Math.random()*80) + "px";
      el.style.background = colors[(Math.random()*colors.length)|0];
      el.style.animationDuration = (0.9 + Math.random()*0.9) + "s";
      el.style.opacity = (0.65 + Math.random()*0.35);
      confettiEl.appendChild(el);
    }
    setTimeout(clearConfetti, 1400);
  }

  function buildArena(){
    lanesEl.innerHTML = "";
    runners = [];
    championCard.classList.remove("show");

    active.forEach((name, idx) => {
      const lane = document.createElement("div");
      lane.className = "lane";

      const finish = document.createElement("div");
      finish.className = "finish";

      const label = document.createElement("div");
      label.className = "label";
      label.textContent = name;

      const runner = document.createElement("div");
      runner.className = "runner";
      runner.style.background = `linear-gradient(135deg, ${palette[idx % palette.length]}, rgba(255,255,255,.85))`;

      const face = document.createElement("div");
      face.className = "face";
      const mouth = document.createElement("div");
      mouth.className = "mouth";
      face.appendChild(mouth);

      const legs = document.createElement("div");
      legs.className = "legs";
      legs.innerHTML = `<span class="leg"></span><span class="leg"></span>`;

      runner.appendChild(face);
      runner.appendChild(legs);

      lane.appendChild(finish);
      lane.appendChild(label);
      lane.appendChild(runner);
      lanesEl.appendChild(lane);

      runners.push({ name, laneEl: lane, runnerEl: runner, x:0 });
    });

    updateBadges();
  }

  function renderBoard(){
    boardEl.innerHTML = "";
    winners.forEach((name, idx) => {
      const item = document.createElement("div");
      item.className = "boardItem";
      item.innerHTML = `<div style="display:flex;align-items:center;gap:10px">
        <div class="rank">${idx+1}</div><div style="font-weight:900">${name}</div>
      </div><div style="font-weight:900;opacity:.8">üèÅ</div>`;
      boardEl.appendChild(item);
    });
  }

  function pickWinnerIndex(){ return (Math.random()*runners.length)|0; }

  function laneMaxX(laneEl, runnerEl){
    const laneW = laneEl.clientWidth;
    const runnerW = runnerEl.clientWidth;
    const finishOffsetFromRight = 92;
    const finishX = laneW - finishOffsetFromRight;
    return Math.max(0, finishX - runnerW*0.45);
  }

  function setRunnerPos(r, x){
    r.x = x;
    r.runnerEl.style.transform = `translate(${x}px,-50%)`;
  }

  function startRound(){
    if (running) return;
    if (active.length <= 1){ showChampion(); return; }

    running = true;
    btnStart.disabled = true;
    btnNext.disabled = true;

    startMusic();

    runners.forEach(r => {
      r.laneEl.classList.remove("win");
      r.runnerEl.classList.remove("winnerGlow");
      r.runnerEl.classList.add("running");
      setRunnerPos(r, 0);
    });

    winnerIndex = pickWinnerIndex();
    startTime = performance.now();

    const duration = 4200 + Math.random()*900;
    const easeOut = (t) => 1 - Math.pow(1 - t, 3);

    function frame(now){
      const t = (now - startTime) / duration;
      const p = Math.min(1, Math.max(0, t));
      const e = easeOut(p);

      runners.forEach((r, i) => {
        const maxX = laneMaxX(r.laneEl, r.runnerEl);
        const wiggle = Math.sin((now/120) + i) * 0.6;

        let prog = (p < 0.72) ? e * 0.88 : (0.88 + (e - 0.88) * 1.25);

        if (i === winnerIndex){
          if (p > 0.68) prog += (p - 0.68) * 0.38;
        } else {
          if (p > 0.75) prog -= (p - 0.75) * 0.14;
        }

        prog = Math.min(1, Math.max(0, prog));
        const x = Math.min(maxX, maxX * prog + wiggle);
        setRunnerPos(r, x);
      });

      if (p < 1){
        rafId = requestAnimationFrame(frame);
      } else {
        endRound();
      }
    }

    rafId = requestAnimationFrame(frame);
  }

  function endRound(){
    running = false;
    if (rafId) cancelAnimationFrame(rafId);

    runners.forEach(r => r.runnerEl.classList.remove("running"));

    const win = runners[winnerIndex];
    win.laneEl.classList.add("win");
    win.runnerEl.classList.add("winnerGlow");

    winners.push(win.name);
    active = active.filter(n => n !== win.name);

    renderBoard();
    updateBadges();
    popConfetti();
    sfxWin();

    btnNext.disabled = (active.length <= 1);
    if (active.length <= 1) setTimeout(showChampion, 350);
  }

  function showChampion(){
    if (active.length === 1){
      championName.textContent = "üèÜ " + active[0];
      championCard.classList.add("show");
      popConfetti();
    }
    btnStart.disabled = true;
    btnNext.disabled = true;
  }

  function nextRound(){
    if (running) return;
    if (active.length <= 1){ showChampion(); return; }
    round++;
    btnStart.disabled = false;
    btnNext.disabled = true;
    buildArena();
  }

  function resetAll(){
    if (rafId) cancelAnimationFrame(rafId);
    running = false;
    round = 1;
    winners = [];
    active = [...initialPlayers];
    renderBoard();
    buildArena();
    updateBadges();
    btnStart.disabled = false;
    btnNext.disabled = true;
    clearConfetti();
    championCard.classList.remove("show");
  }

  btnStart.addEventListener("click", startRound);
  btnNext.addEventListener("click", nextRound);
  btnReset.addEventListener("click", resetAll);

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space"){
      e.preventDefault();
      if (!btnStart.disabled) btnStart.click();
      else if (!btnNext.disabled) btnNext.click();
    }
    if (e.key.toLowerCase() === "r") btnReset.click();
    if (e.key.toLowerCase() === "m"){ muted = !muted; if(master) master.gain.value = muted ? 0 : 0.55; }
  });

  active = [...initialPlayers];
  renderBoard();
  buildArena();
  updateBadges();
  btnStart.disabled = false;
  btnNext.disabled = true;
})();
</script>
</body>
</html>
